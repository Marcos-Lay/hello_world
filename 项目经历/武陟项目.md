# 武陟项目（阿里对接项目）
## 原理
- 基于OAuth2授权标准来与阿里服务提供方进行交互。
## 建立物模型
- 使用阿里linkcity平台定义物模型，顺舟设备的属性要在linkcity平台进行预创建，由阿里分配deviceName来与顺舟设备进行绑定。
- 物模型中设备的属性要与顺舟平台中的设备属性类型来对应，如果创建类型不合理，要在代码逻辑中进行强转。
## 云云对接
- 云云对接架构采用 spring+springMVC+mybatis+reids+mongodb+quartz+rabbitMQ
- 定时向阿里平台推送顺舟设备数据，采用spring中quartz定时向阿里发送，定时任务的推送时间由顺舟来定义。
- 顺舟设备的属性存储在mongodb中，因为设备的属性多种多样，相同类型的设备属性也有可能不同，因此mongodb的文档式存储比较合适，顺舟设备的所有在线状态在redis中存储，由于在线状态的变化较为频繁，因此采用redis来处理频繁写操作。
- 与阿里提供绑定的设备配置在配置文件中，采用动态读取配置文件的方式，支持在不重启服务的情况下动态的修改配置文件，原理是监听配置文件是否发生变化，如果变化执行init初始化。
- 由于系统中包括不同的推送任务，采用注解@Profile来在ide启动时自动识别要运行的项目。（后期可以采用dobbu分模块架构）
## 统一登陆（阿里用户免登陆进入顺舟云平台）
- 统一登陆架构采用 spring+springMVC+mybatis+mongodb+rabbitMQ
- 统一登陆是与阿里合作，使阿里的用户在阿里的linkcity平台上免登进入顺舟云平台（顺舟云平台作为阿里linkcity的应用）
#### 统一登陆逻辑
- 顺舟为阿里提供一个免登的URL（也就是一个requestMapping），用户点击免登URL时首先判断用户是否已经登陆过，如已经登陆则直接跳转到顺舟云平台首页。
- 如用户未登录，则判断用户是否为首次登陆，如不是首次登陆则直接进入顺舟云平台首页，同时在session中维护用户信息。
- 用户如果是首次登陆，则跳转到阿里提供的回调URL中，URL中包括回调顺舟云平台的URL，根据阿里回调的URL中的code来获取Token，再根据Token来获取用户的信息，跳转到用户信息补充页面让用户来填写一些顺舟平台必要的信息(主要用于业务上绑定用户的权限)。
- 填写完毕之后跳转到顺舟云平台首页，在session维护用户信息，并且为用户初始化权限。
- 用户如果从阿里linkcity平台登出，则阿里会调用顺舟平台为阿里提供的登出URL，之后平台session中清除会话信息。
